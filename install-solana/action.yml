name: Install Solana

inputs:
  version:
    description: The Solana version to install
    required: true
    default: "stable"
  cache:
    description: Whether the built Solana release should be cached
    required: true
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Cache Solana
      id: cache
      if: inputs.cache == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.local/share/solana/install/releases/${{ inputs.version }}
        key: ${{ runner.os }}-solana-source-v${{ inputs.version }}

    - name: Install Build Dependencies
      if: inputs.cache != 'true' || steps.cache.outputs.cache-hit != 'true'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libudev-dev llvm libclang-dev protobuf-compiler
        elif [ "$RUNNER_OS" == "macOS" ]; then
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo "Homebrew installed successfully"
          fi
          brew install pkg-config libudev protobuf llvm coreutils
        fi
      shell: bash


    - name: Build Solana from Source
      if: inputs.cache != 'true' || steps.cache.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch v${{ inputs.version }} https://github.com/solana-labs/solana.git
        cd solana
        ./scripts/cargo-install-all.sh ~/.local/share/solana/install/releases/${{ inputs.version }}
      shell: bash

    - name: Set Active Solana Version
      run: |
        rm -f "$HOME/.local/share/solana/install/active_release"
        ln -s "$HOME/.local/share/solana/install/releases/${{ inputs.version }}/solana-release" "$HOME/.local/share/solana/install/active_release"
      shell: bash

    - name: Add Solana bin to Path
      run: |
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      shell: bash

    - name: Verify Solana install
      run: |
        solana --version
      shell: bash
